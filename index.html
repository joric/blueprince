<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Joric's Blue Prince - Mora Jai Box Puzzle Solver</title>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta property="og:image" content="https://joric.github.io/blueprince/images/thumbnail.jpg" />
<meta property="og:site_name" content="Joric" />
<meta property="og:type" content="object" />
<meta property="og:title" content="Joric's Blue Prince" />
<meta property="og:description" content="Mora Jai Box Solver" />
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3C!--!Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--%3E%3Cpath d='M352 96c0 14.3-3.1 27.9-8.8 40.2L396 227.4c-23.7 25.3-54.2 44.1-88.5 53.6L256 192c0 0 0 0 0 0s0 0 0 0l-68 117.5c21.5 6.8 44.3 10.5 68.1 10.5c70.7 0 133.8-32.7 174.9-84c11.1-13.8 31.2-16 45-5s16 31.2 5 45C428.1 341.8 347 384 256 384c-35.4 0-69.4-6.4-100.7-18.1L98.7 463.7C94 471.8 87 478.4 78.6 482.6L23.2 510.3c-5 2.5-10.9 2.2-15.6-.7S0 501.5 0 496l0-55.4c0-8.4 2.2-16.7 6.5-24.1l60-103.7C53.7 301.6 41.8 289.3 31.2 276c-11.1-13.8-8.8-33.9 5-45s33.9-8.8 45 5c5.7 7.1 11.8 13.8 18.2 20.1l69.4-119.9c-5.6-12.2-8.8-25.8-8.8-40.2c0-53 43-96 96-96s96 43 96 96zm21 297.9c32.6-12.8 62.5-30.8 88.9-52.9l43.7 75.5c4.2 7.3 6.5 15.6 6.5 24.1l0 55.4c0 5.5-2.9 10.7-7.6 13.6s-10.6 3.2-15.6 .7l-55.4-27.7c-8.4-4.2-15.4-10.8-20.1-18.9L373 393.9zM256 128a32 32 0 1 0 0-64 32 32 0 1 0 0 64z'/%3E%3C/svg%3E" />

<style>
body {
  margin: 0;
  padding: 0;
  overflow: hidden;
}

.container {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
}

.box {
  width: min(90vw, 90vh);
  aspect-ratio: 1;
  display: grid;
  grid-template-columns: 15% 70% 15%;
  grid-template-rows: 15% 70% 15%;
}

.box h1 {
  font-size: min(5cqw, 5cqh);
}

.box h2 {
  font-size: min(5cqw, 5cqh);
}

.tiles {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  grid-template-rows: repeat(3, 1fr);
  gap: 1%;
  perspective: 1000px;
}

.corner {
  display: flex;
  perspective: 500px;
}

.spacer {
  display: flex;
  justify-content: center;
  align-items: center;
}

.spacer-left {
  justify-content: left;
  align-items: left;
}

.spacer-right {
  justify-content: right;
  align-items: right;
}

.tiles button {
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: min(6cqw, 6cqh);
}

.palette {
  display: grid;
  grid-template-rows: repeat(5, 1fr);
  grid-template-columns: repeat(1, 1fr);
  height: 90%;
  aspect-ratio: 1/5;
  gap: 1%;
  margin-top: -18%;
}

.palette button {
  font-size: min(6cqw, 6cqh);
  line-height: min(6cqw, 6cqh);
}

.box button {
  cursor: pointer;
  position: relative;
  aspect-ratio: 1;
  z-index: 1;
}

.box button::before {
  position: absolute;
  inset: 0;
  pointer-events: none;
  z-index: -1;
  content: "";
}

.box button::after {
  position: absolute;
  inset: 0;
  pointer-events: none;
  z-index: -1;
  content: '';
}

.black::before { background: black; }
.red::before { background: red; }
.yellow::before { background: yellow; }
.purple::before { background: purple; }
.orange::before { background: orange; }
.white::before { background: white; }
.pink::before { background: pink; }
.green::before { background: green; }
.blue::before { background: blue; }

.black, .red, .purple, .blue, .green { color: white; }

*::after { background: black; }
.black::after, .red::after, .purple::after, .blue::after, .green::after { background: white; }

.black::after { mask:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path style="stroke-width: 25px; fill: none; stroke: black;" d="M 228,32 H 284 L 325,102 H 368 V 410 H 326 L 284,481 H 228 L 185,410 H 143 L 143,102 H 185 Z" /></svg>') }
.red::after { mask:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path style="stroke-width: 25px; fill: none; stroke: black;" d="M 96,212 L 159,401 L 357,399 L 417,210 L 256,95 Z" /></svg>') }
.yellow::after { mask:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path style="stroke-width: 25px; fill: none; stroke: black;" d="M 89,448 H 437 L 310,80 L 235,258 L 184,175 Z" /></svg>') }
.purple::after { mask:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path style="stroke-width: 25px; fill: none; stroke: black;" d="M 335,255 L 389,442 H 122 L 176,255 L 122,68 H 389 Z" /></svg>') }
.orange::after { mask:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path style="stroke-width: 25px; fill: none; stroke: black;" d="M 256,432 L 480,192 L 384,96 L 256,192 L 128,96 L 32,192 Z" /></svg>') }
.white::after { mask:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path style="stroke-width: 25px; fill: none; stroke: black;" d="M 213,384 C 213,384 220,342 256,342 C 291,342 298,384 298,384 L 473,349 C 473,349 480,111 256,111 C 31,111 38,349 38,349 Z" /></svg>') }
.pink::after { mask:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path style="stroke-width: 25px; fill: none; stroke: black;" d="M 267,380 L 199,447 L 63,312 L 312,63 L 448,199 L 380,266 C 380,266 436,323 379,379 C 323,435 267,380 267,380 Z" /></svg>') }
.green::after { mask:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path style="stroke-width: 25px; fill: none; stroke: black;" d="M 256,30 L 438,255 L 256,479 L 73,255 Z" /></svg>') }
.blue::after { mask:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path style="stroke-width: 25px; fill: none; stroke: black;" d="M 256,54 C 256,54 270,138 284,166 C 297,193 333,208 333,208 C 333,208 291,264 312,313 C 333,362 396,362 396,362 C 396,362 374,388 368,404 C 362,421 354,446 354,446 C 354,446 335,425 312,425 C 284,425 278,453 256,453 C 233,453 227,425 199,425 C 171,425 157,446 157,446 C 157,446 149,421 143,404 C 137,388 115,362 115,362 C 115,362 178,355 199,306 C 220,257 178,215 178,215 C 178,215 199,201 220,166 C 241,131 256,54 256,54 Z" /></svg>') }

.palette button::after {
  margin: 10%;
}

.tiles button::after {
  content: none;
}

.corner button::before {
  opacity: 0;
}

.corner button::after {
  background: black;
}

.grey::after {
  opacity: 0;
}

.presets {
  position: absolute;
  top: 0;
  max-width: 120px;
  margin: 12px;
}

</style>

<script>

//////////////////////////////////////////////////////////////////////////////
// Blue Prince Mora Jai Box solver
// Originally from https://www.reddit.com/r/BluePrince/comments/1kefpbv/i_made_a_puzzle_box_solver/
// Ported to JS by Joric https://github.com/joric/blueprince

const crossAroundIndexes = [
  [1, 3], [0, 2, 4], [1, 5],
  [0, 4, 6], [1, 3, 5, 7], [2, 4, 8],
  [3, 7], [6, 4, 8], [5, 7]
];

const allAroundIndexes = [
  [1, 4, 3], [2, 5, 4, 3, 0], [5, 4, 1],
  [0, 1, 4, 7, 6], [0, 1, 2, 5, 8, 7, 6, 3], [8, 7, 4, 1, 2],
  [3, 4, 7], [6, 3, 4, 5, 8], [7, 4, 5]
];

const rowsIndexes = [
  [0, 1, 2], [0, 1, 2], [0, 1, 2],
  [3, 4, 5], [3, 4, 5], [3, 4, 5],
  [6, 7, 8], [6, 7, 8], [6, 7, 8]
];

class SolutionNode {
  constructor(parent, board, move) {
    this.parent = parent;
    this.board = board;
    this.move = move;
  }
}

function swap(board, i, j) {
  [board[i], board[j]] = [board[j], board[i]];
}

function rotate(board, indices) {
  const last = board[indices[indices.length - 1]];
  for (let i = indices.length - 1; i > 0; i--) {
    board[indices[i]] = board[indices[i - 1]];
  }
  board[indices[0]] = last;
}

function invertColors(board, idx, c1, c2) {
  if (board[idx] === c1) board[idx] = c2;
  else if (board[idx] === c2) board[idx] = c1;
}

const colorFunctions = {
  'grey': () => {},
  'green': (b, i) => swap(b, i, 8 - i),
  'orange': (b, i) => {
    const counts = {};
    for (const j of crossAroundIndexes[i]) {
      counts[b[j]] = (counts[b[j]] || 0) + 1;
    }
    const entries = Object.entries(counts).sort((a, b) => b[1] - a[1]);
    if (entries.length > 0 && entries.filter(e => e[1] === entries[0][1]).length === 1) {
      b[i] = entries[0][0];
    }
  },
  'black': (b, i) => rotate(b, rowsIndexes[i]),
  'red': (b) => {
    for (let i = 0; i < 9; i++) {
      if (b[i] === 'black') b[i] = 'red';
      else if (b[i] === 'white') b[i] = 'black';
    }
  },
  'white': (b, i) => {
    const original = b[i];
    for (const j of crossAroundIndexes[i]) {
      invertColors(b, j, original, 'grey');
    }
    invertColors(b, i, original, 'grey');
  },
  'purple': (b, i) => { if (i < 6) swap(b, i, i + 3); },
  'yellow': (b, i) => { if (i > 2) swap(b, i, i - 3); },
  'pink': (b, i) => rotate(b, allAroundIndexes[i]),
  'blue': (b, i) => {
    if (b[4] !== 'blue') colorFunctions[b[4]](b, i);
  }
};

function isStillPossible(board, expected) {
  return !(expected.includes('blue') && !board.includes('blue'));
}

function isSolution(board, expected) {
  return board[0] === expected[0] &&
         board[2] === expected[1] &&
         board[6] === expected[2] &&
         board[8] === expected[3];
}

function clickBoard(board, idx) {
  colorFunctions[board[idx]](board, idx);
}

function copyBoard(board) {
  return [...board];
}

function remapSolverIndex(j) {
  //let i = useNumpad ? [6,7,8,3,4,5,0,1,2][j] : j; // scan as numpad? solver still doesn't match https://kkawabat.github.io/MoraJaiBox/
  let i = j;
  //console.log(j+1,'=>', i+1);
  return i;
}

function treeSolve(board, expected) {
  const root = new SolutionNode(null, copyBoard(board), null);
  const seen = new Set();
  seen.add(board.join(''));
  const levels = [[root]];

  for (let depth = 0; depth < 20; depth++) {
    const currentLevel = levels[depth];
    const nextLevel = [];
    for (const node of currentLevel) {
      for (let j = 0; j < 9; j++) {
        let i = remapSolverIndex(j);
        const newBoard = copyBoard(node.board);
        clickBoard(newBoard, i);
        const hash = newBoard.join('');
        if (isStillPossible(newBoard, expected) && !seen.has(hash)) {
          seen.add(hash);
          const child = new SolutionNode(node, newBoard, i);
          if (isSolution(newBoard, expected)) return child;
          nextLevel.push(child);
        }
      }
    }
    levels.push(nextLevel);
  }

  return null;
}

function getMoves(node) {
  const moves = [];
  while (node) {
    if (node.move !== null) {
      moves.unshift(node.move);
    }
    node = node.parent;
  }
  return moves;
}

//////////////////////////////////////////////////////////////////////////////

//let defaultPreset = 'Trading Post';
let defaultPreset = null;
let defaultColor = 'grey';
let selectedColor = 'black';
let editMode = true;
let savedState = null;
let timer = null;
let useNumpad = true;
let lastColor = 'black';
let gameBoard = new Array(14);
gameBoard.fill('grey');

// Based on https://github.com/kkawabat/MoraJaiBox/blob/main/scripts/mora_jai_boxes.js
// See https://www.reddit.com/r/BluePrince/comments/1jwyu8z/late_game_puzzle_help_box/msh4un4/
// I don't use solutions from here but I put them into tooltips so you can compare them
const presets = [
  { location: "Trading Post",
    pattern:"pink grey grey grey yellow yellow grey yellow yellow yellow yellow yellow yellow",
    solution: "742544446"
  },
  {
    location: "Tunnel",
    pattern: "black orange pink orange orange orange pink orange orange orange orange orange orange",
    solution: "7444"
  },
  {
    location: "Blue Prince Throne Room",
    pattern: "black green blue blue blue blue purple grey grey blue blue blue blue",
    solution: "79898647"
  },
  {
    location: "Lost and Found",
    pattern: "pink pink pink pink grey pink grey grey grey pink pink pink pink",
    solution: "9632122227714488"
  },
  {
    location: "Closed Exhibit",
    pattern: "orange black orange orange red orange orange black orange red red red red",
    solution: "286979313285"
  },
  {
    location: "Clara Tomb",
    pattern: "grey purple grey grey pink grey purple purple purple purple purple purple purple",
    solution: "5955596595"
  },
  {
    location: "Solarium",
    pattern: "green grey yellow green yellow green yellow grey green green green green green",
    solution: "1161"
  },
  {
    location: "Master Bedroom",
    pattern: "white grey white white grey grey grey grey white white white white white",
    solution: "78526"
  },
  { location: "Inner sanctum Orindia",
    pattern:"green black green black black black green yellow green black black black black",
    solution: "2661143222928"
  },
  {
    location: "Inner sanctum Fenn Aries",
    pattern: "grey green grey orange red orange white green black red red red red",
    solution: "38811493622371247455"
  },
  {
    location: "Inner sanctum Arch Aries",
    pattern: "black yellow grey yellow green yellow grey yellow black yellow yellow yellow yellow",
    solution: "2623878219446"
  },
  {
    location: "Inner sanctum Eraja",
    pattern: "yellow purple yellow green red black purple purple purple purple purple purple purple",
    solution: "68848829971879756556"
  },
  {
    location: "Inner sanctum Corarica",
    pattern: "orange black orange orange orange orange purple green purple orange orange orange orange",
    solution: "829971879779397"
  },
  {
    location: "Inner sanctum Mora Jai",
    pattern: "yellow yellow yellow white pink white grey grey grey white white white white",
    solution: "412555513"
  },
  {
    location: "Inner sanctum Verra",
    pattern: "pink pink grey grey grey grey orange orange orange pink pink pink pink",
    solution: "77484744525886"
  },
  {
    location: "Inner sanctum Nuance",
    pattern: "pink pink grey grey grey grey orange orange orange pink pink pink pink",
    solution: "76239979895787131266747"
  },
  {
    location: "The Unknown Box #1",
    pattern: "black black black green black grey grey grey pink black black black black",
    solution: "33432222"
  },
  {
    location: "The Unknown Box #2",
    pattern: "orange grey purple orange grey purple black black black black black black black",
    solution: "32264699888"
  },
  {
    location: "The Unknown Box #3",
    pattern: "black black black grey grey grey pink purple orange black black black black",
    solution: "144453396"
  },
  {
    location: "The Unknown Box #4",
    pattern: "black black black orange grey orange yellow grey yellow black black black black",
    solution: "3661155612288"
  },
  {
    location: "The Unknown Box #5",
    pattern: "orange grey pink black grey black green grey orange black black black black",
    solution: "99711199399882"
  },
  {
    location: "The Unknown Box #6",
    pattern: "black purple black grey grey grey orange green orange black black black black",
    solution: "2998881878838"
  },
  {
    location: "The Unknown Box #7",
    pattern: "orange orange orange black green black purple green purple black black black black",
    solution: "2286878722877723"
  },
  {
    location: "The Unknown Box #8",
    pattern: "black green yellow black black black grey grey grey black black black black",
    solution: "8782992522336811119"
  },
  {
    location: "Blueprints A1",
    pattern: "black grey orange orange green orange orange green yellow green green green green",
    solution: "27688439978897"
  },
  {
    location: "Blueprints A2",
    pattern: "pink pink pink orange orange orange purple purple purple purple purple purple purple",
    solution: "9646662848"
  },
  {
    location: "Blueprints A3",
    pattern: "yellow yellow yellow black yellow green grey blue grey yellow yellow yellow yellow",
    solution: "4256336497989146"
  },
  {
    location: "Blueprints A4",
    pattern: "blue purple blue black blue purple blue purple purple blue blue blue blue",
    solution: "41254"
  },
  {
    location: "Blueprints A5",
    pattern: "black black black grey orange grey pink red pink red red red red",
    solution: "122444227"
  },
    {
    location: "Blueprints B1",
    pattern: "orange yellow orange green grey green blue green blue green green green green",
    solution: "279231"
  },
  {
    location: "Blueprints B2",
    pattern: "purple purple purple black grey grey orange blue orange purple purple purple purple",
    solution: "846654"
  },
  {
    location: "Blueprints B3",
    pattern: "grey black grey yellow blue yellow blue blue blue blue blue blue blue",
    solution: "866141"
  },
  {
    location: "Blueprints B4",
    pattern: "pink orange orange blue blue pink orange orange pink blue blue blue blue",
    solution: "753535"
  },
  {
    location: "Blueprints B5",
    pattern: "pink black pink orange grey orange pink red pink orange red orange red",
    solution: "8713553159"
  },
  {
    location: "Blueprints C1",
    pattern: "black green black orange purple orange blue green blue green green green green",
    solution: "517684988971"
  },
  {
    location: "Blueprints C2",
    pattern: "white white white yellow white black blue blue blue blue blue blue blue",
    solution: "66134561"
  },
  {
    location: "Blueprints C3",
    pattern: "pink orange pink orange blue orange pink orange pink orange orange orange orange",
    solution: "12115"
  },
  {
    location: "Blueprints C4",
    pattern: "green blue grey black blue grey purple blue blue blue blue blue blue",
    solution: "433789922"
  },
  {
    location: "Blueprints C5",
    pattern: "purple white purple white white white blue pink blue blue blue blue blue",
    solution: "486272292922262626228222"
  },
  {
    location: "Blueprints D1",
    pattern: "red green orange black black black purple blue purple purple purple purple purple",
    solution: "2888925631562796689177893316723851"
  },
  {
    location: "Blueprints D2",
    pattern: "orange green orange yellow orange orange blue yellow orange orange orange orange orange",
    solution: "218541"
  },
  {
    location: "Blueprints D3",
    pattern: "green yellow green blue orange blue blue orange blue blue blue blue blue",
    solution: "792223146"
  },
  {
    location: "Blueprints D4",
    pattern: "pink blue blue blue blue purple green grey pink blue blue blue blue",
    solution: "6163672222"
  },
  {
    location: "Blueprints D5",
    pattern: "orange yellow orange green yellow green black yellow black green yellow green yellow",
    solution: "3322273816"
  },
  {
    location: "Blueprints E1",
    pattern: "pink white pink blue grey blue pink red pink red red red red",
    solution: "786528713211393"
  },
  {
    location: "Blueprints E2",
    pattern: "white red grey grey pink grey black red white white white white white",
    solution: ""
  },
  {
    location: "Blueprints E3",
    pattern: "grey orange orange yellow orange black blue blue orange orange orange orange orange",
    solution: "6245246417"
  },
  {
    location: "Blueprints E4",
    pattern: "green white white black white black blue white blue blue blue blue blue",
    solution: "79475586772318552"
  },
  {
    location: "Blueprints E5",
    pattern: "black blue grey blue orange blue black orange yellow blue blue blue blue",
    solution: "171552146422"
  },
  {
    location: "Blueprints F1",
    pattern: "black green black grey orange grey purple purple purple purple purple purple purple",
    solution: "88722878897531"
  },
  {
    location: "Blueprints F2",
    pattern: "pink white pink orange red orange purple white purple purple purple purple purple",
    solution: "5875643444974562442561"
  },
  {
    location: "Blueprints F3",
    pattern: "yellow orange yellow orange orange orange pink orange pink orange orange orange orange",
    solution: "21445551222"
  },
  {
    location: "Blueprints F4",
    pattern: "pink orange pink orange orange orange green orange green orange orange orange orange",
    solution: "875"
  },
  {
    location: "Blueprints F5",
    pattern: "black blue black black green orange blue green blue green green green green",
    solution: "4517827219731"
  },
  {
    location: "Blueprints G1",
    pattern: "pink white pink black red black grey grey grey red red red red",
    solution: "75289877"
  },
  {
    location: "Blueprints G2",
    pattern: "pink orange purple orange grey grey pink blue purple purple purple purple purple",
    solution: "1478991227228455595"
  },
  {
    location: "Blueprints G3",
    pattern: "yellow yellow yellow black black black grey green grey black yellow black yellow",
    solution: "22283351277836292"
  },
  {
    location: "Blueprints G4",
    pattern: "yellow yellow yellow black grey black orange green orange yellow yellow yellow yellow",
    solution: "2622882321"
  },
  {
    location: "Blueprints G5",
    pattern: "grey pink grey orange green orange purple grey purple purple purple purple purple",
    solution: "887788984884968"
  },
  {
    location: "Blueprints H1",// (Foyer, CAST)",
    pattern: "green green green grey orange orange blue grey purple green green green green",
    solution: "766749449"
  },
  {
    location: "Blueprints H2",// (Pool, A)",
    pattern: "red white yellow blue green blue blue yellow blue red red red red",
    solution: "256564542287899"
  },
  {
    location: "Blueprints H3",// (Servants Quarters, TINT)",
    pattern: "grey grey grey black red black white grey yellow black black black black",
    solution: "364147346388"
  },
  {
    location: "Blueprints H4",// (Pump Room, OF)",
    pattern: "purple blue purple black green orange black green orange purple purple purple purple",
    solution: "4589156253971"
  },
  {
    location: "Blueprints H5", // (Furnace, TRUTH)",
    pattern: "black grey grey white green white blue yellow orange blue blue blue blue", // fixed colors
    solution: "227565146412292" // added solution
  },
  {
    location: "Blueprints i1",// (Archives, THROUGH)",
    pattern: "red grey black orange orange orange green grey purple orange red orange red",
    solution: "1199162399718987871"
  },
  {
    location: "Blueprints i2",// (Chapel, LANTERN)",
    pattern: "blue orange blue black black orange blue orange blue orange orange orange orange",
    solution: "175582617"
  },
  {
    location: "Blueprints i3",// (Vectibule, LIGHT)",
    pattern: "grey green grey orange black red black white purple black purple red orange",
    solution: "88212858351223868215839"
  },
  {
    location: "Blueprints i4",// (Coat Check, IN)",
    pattern: "yellow green yellow black black black blue green blue blue black black blue",
    solution: "33337735377812"
  },
  {
    location: "Blueprints i5",// (Aquarium, SKETCHES)",
    pattern: "pink grey yellow red yellow white orange blue black yellow yellow yellow yellow",
    solution: "744442544448443244"
  },
  {
    location: "Blueprints 46th room",// (was Furnace, BLUE)",
    pattern: "orange pink orange grey green grey blue grey blue blue blue blue blue",
    solution: "18868889868888"
  },
  { location: "Underpass", // see https://deltiasgaming.com/blue-prince-how-to-solve-the-underpass-mora-jai-puzzle-box/
    pattern:"black black black grey black grey yellow grey yellow black black black black",
    solution: "5367861"
  },
]

function fillPresets() {
  let select = document.querySelector('.presets');
  for (const entry of presets) {
    let option = document.createElement('option');
    option.textContent = option.value = entry.location;
    option.title = entry.solution;
    select.append(option);
  }

  document.querySelector('.presets').onchange = e=> {
    setEditMode(false);
    loadPreset(e.target.value);
    savedState = getState();
    clearTimeout(timer);
    timer = setTimeout(updateSolution, 250);
  }
}


function loadEntry(entry) {
  let data = entry.pattern.split(' ');
  let start = data.slice(0,10);
  let expected = data.slice(-4);
  expected = [0, 1, 3, 2].map(i => expected[i]);
  updateColors(start, expected);
}

function loadPreset(preset) {
  for (const entry of presets) {
    if (preset==entry.location) {
      return loadEntry(entry);
    }
  }
  let data = new Array(14); data.fill('grey');
  loadEntry({pattern: data.join(' ')});
}

function remapIndex(i) {
  return useNumpad ? [7,8,9,4,5,6,1,2,3][i] : i+1;
}

function remapMoves(moves) {
  return moves.map( i => { return remapIndex(i); });
}

function selectColor(color) {
  selectedColor = color;
  document.querySelectorAll('.palette button').forEach((div,i) => {
    div.style.border = color==div.className ? '4px solid black' : '';
    if (div.className=='grey') div.innerHTML = editMode ? '&#9658;': '&#9724;';
  });
}

function getState() {
  let start = [], expected = [];
  document.querySelectorAll('.tiles button').forEach((div,i) => { start[i] = gameBoard[i]; });
  document.querySelectorAll('.corner button').forEach((div,i) => { expected[i] = gameBoard[i+9]; });
  return {start:start, expected:expected};
}

function updateSolution() {
  let div = document.querySelector('#result');
  let state = getState();

  if (state.start.every(x=>x=='grey')) { div.textContent = 'Paint Tiles'; return; }
  if (state.expected.every(x=>x=='grey')) { div.textContent = 'Set Corners'; return; }

  if (isSolution(state.start, state.expected)) {
    div.textContent = 'Solved';
  } else {
    const result = treeSolve(state.start, state.expected);
    if (result) {
      let moves = getMoves(result);
      div.textContent = remapMoves(moves, useNumpad).join('');
    } else {
      div.textContent = 'Solution not found';
    }
  }
}

function setColor(div, i, color) {
  gameBoard[i] = color;

  let oldColor = div.className;
  if (oldColor=='') { div.className='grey'; return; }
  if (oldColor == color) return;

  div.animate(
    [{ transform: 'rotateY(0deg)' }, { transform: 'rotateY(90deg)' }],
    { duration: 150, fill: 'forwards', easing: 'ease-in' }
  ).onfinish = () => {
    div.className = color;
    div.animate(
      [{ transform: 'rotateY(-90deg)' }, { transform: 'rotateY(0deg)' }],
      { duration: 150, fill: 'forwards', easing: 'ease-out' }
    )
  };
}

function setEditMode(mode) {
  if (editMode) {
    savedState = getState();
  } else {
    updateColors(savedState.start, savedState.expected);
  }
  editMode = mode;
  
  if (!editMode) selectColor('grey');

  document.querySelector('#title').textContent = editMode ? 'Mora Jai Box Solver' : 'Simulation Mode';
  updateSolution();
}

function toggleMode(e) {
  setEditMode(!editMode);
}

function paletteClick(e) {
  let color = e.target.className;

  if (selectedColor!='grey') {
    lastColor = selectedColor;
  }

  if (color=='grey') {
    if (editMode) {
      setEditMode(false);
    } else {
      color = lastColor;
      setEditMode(true);
    }
  } else {
    setEditMode(true);
  }

  selectColor(color);
}

function tileClick(div, i) {
  if (editMode) {
    setColor(div, i, gameBoard[i] == selectedColor ? 'grey' : selectedColor);
    document.querySelector('.presets').selectedIndex = 0;
  } else {
    if (i>=9) return;
    let state = getState();
    clickBoard(state.start, i);
    updateColors(state.start, state.expected);
  }

  clearTimeout(timer);
  timer = setTimeout(updateSolution, 250);
}

function updateColors(start, expected) {
  document.querySelectorAll('.tiles button').forEach((div,i) => { setColor(div, i, start[i]); });
  document.querySelectorAll('.corner button').forEach((div,i) => { setColor(div, i+9, expected[i]); });
  document.querySelectorAll('.tiles button').forEach((div,i) => { div.textContent = remapIndex(i); });
}

window.onload = function(event) {
  fillPresets();
  loadPreset(defaultPreset);
  selectColor(selectedColor);
  setEditMode(editMode);

  document.querySelectorAll('.palette button').forEach((div,i) => div.onclick = paletteClick );
  document.querySelectorAll('.tiles button').forEach((div,i) => { div.onclick = e=> { tileClick(div,i); }});
  document.querySelectorAll('.corner button').forEach((div,i) => { div.onclick = e=> { tileClick(div,i+9); }});

  window.addEventListener("keydown",function (e) {
    switch(e.code) {
      case 'Enter': toggleMode();
    }
    !editMode && document.querySelectorAll('.tiles button').forEach((div,i) => {
      if (div.textContent==e.key) {
        tileClick(div, i);
      }
    });
  });
}

</script>

</head>
<body>

<div class="container">
  <div class="box">

    <div class="corner"><button></button></div>
    <div class="spacer"><h1 id="title"></h1></div>
    <div class="corner"><button></button></div>

    <div class="spacer spacer-left">
      <div class="palette">
        <button class="grey" title="Toggle Simulation Mode"></button>
        <button class="black" title="Orinda Aries: Moves all of the tiles in the row one to the right."></button>
        <button class="red" title="Fenn Aries: Turns all white tiles black and all black tiles red."></button>
        <button class="yellow" title="Arch Aries: Moves up one position."></button>
        <button class="purple" title="Eraja: Moves down one position."></button>
      </div>
    </div>

    <div class="tiles">
      <button></button>
      <button></button>
      <button></button>
      <button></button>
      <button></button>
      <button></button>
      <button></button>
      <button></button>
      <button></button>
    </div>

    <div class="spacer spacer-right">
      <div class="palette">
        <button class="orange" title="Corarica: Changes colors to match the majority of its adjacent tiles.&#013;If they are evenly split, the color stays the same."></button>
        <button class="white" title="Mora Jai: Expands outwards if there are any adjacent gray tiles.&#013;If there are none, the tile disappears."></button>
        <button class="pink" title="Verra: Rotates every adjacent tile one clockwise position."></button>
        <button class="green" title="Nuance: Swaps positions with a tile in the opposite position."></button>
        <button class="blue" title="Copies the ability of the tile in the middle of the 3x3 grid."></button>
      </div>
    </div>

    <div class="corner"><button></button></div>
    <div class="spacer"><h2 id="result"></h2></div>
    <div class="corner"><button></button></div>

  </div>
</div>

<select class="presets"><option>Load Preset</option></select>
<a href="https://github.com/joric/blueprince/wiki/Mora-Jai-Box" target="_blank" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

</body>
</html>
